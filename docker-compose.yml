services:
  # Native KDF with HD wallet support
  kdf-native-hd:
    build:
      context: .
      dockerfile: utils/docker/Dockerfile.kdf_native
      args:
        KDF_BRANCH: ${KDF_BRANCH:-dev}
        KDF_BUILD_COMMIT: ${KDF_BUILD_COMMIT:-unknown}
    container_name: kdf-native-hd
    ports:
      - "7783:8779"  # External:Internal port mapping (8779 is configured in MM2.json)
    volumes:
      - ./utils/docker/kdf-config-kdf-native-hd/MM2.json:/kdf/MM2.json:ro
      - ./utils/docker/kdf-config/coins:/kdf/coins:ro
      - ./utils/docker/kdf-db-native-hd:/kdf/db
    environment:
      - RUST_LOG=info
    networks:
      - kdf-network
    healthcheck:
      test: ["CMD-SHELL", "curl --url 'http://127.0.0.1:8779' --data '{\"method\":\"version\"}' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  # Native KDF with non-HD wallet support
  kdf-native-nonhd:
    build:
      context: .
      dockerfile: utils/docker/Dockerfile.kdf_native
      args:
        KDF_BRANCH: ${KDF_BRANCH:-dev}
        KDF_BUILD_COMMIT: ${KDF_BUILD_COMMIT:-unknown}
    container_name: kdf-native-nonhd
    ports:
      - "7784:8778"  # External:Internal port mapping (8778 is configured in MM2.json)
    volumes:
      - ./utils/docker/kdf-config-kdf-native-nonhd/MM2.json:/kdf/MM2.json:ro
      - ./utils/docker/kdf-config/coins:/kdf/coins:ro
      - ./utils/docker/kdf-db-native-nonhd:/kdf/db
    environment:
      - RUST_LOG=info
    networks:
      - kdf-network
    healthcheck:
      test: ["CMD-SHELL", "curl --url 'http://127.0.0.1:8778' --data '{\"method\":\"version\"}' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  # Newman test runner for Native HD
  newman-native-hd:
    image: postman/newman:latest
    container_name: newman-native-hd
    depends_on:
      kdf-native-hd:
        condition: service_healthy
    volumes:
      - ./postman/generated:/postman:ro
      - ./test-reports:/var/newman:rw
    networks:
      - kdf-network
    environment:
      - KDF_BASE_URL=http://kdf-native-hd:8779
      - WALLET_TYPE=hd
      - ENVIRONMENT=native_hd
    command: [
      "run", "/postman/environments/kdf_native_hd_collection.json",
      "--reporters", "cli,json,junit",
      "--reporter-json-export", "/var/newman/results.json",
      "--reporter-junit-export", "/var/newman/results.xml",
      "--timeout", "60000",
      "--delay-request", "1000",
      "--bail", "folder"
    ]

  # Newman test runner for Native Non-HD
  newman-native-nonhd:
    image: postman/newman:latest
    container_name: newman-native-nonhd
    depends_on:
      kdf-native-nonhd:
        condition: service_healthy
    volumes:
      - ./postman/generated:/postman:ro
      - ./test-reports:/var/newman:rw
    networks:
      - kdf-network
    environment:
      - KDF_BASE_URL=http://kdf-native-nonhd:8778
      - WALLET_TYPE=iguana
      - ENVIRONMENT=native_iguana
    command: [
      "run", "/postman/environments/kdf_native_iguana_collection.json",
      "--reporters", "cli,json,junit",
      "--reporter-json-export", "/var/newman/results.json",
      "--reporter-junit-export", "/var/newman/results.xml",
      "--timeout", "60000",
      "--delay-request", "1000",
      "--bail", "folder"
    ]

 
networks:
  kdf-network:
    driver: bridge

volumes:
  kdf-db-native-hd:
  kdf-db-native-nonhd:
  test-reports:
